<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Docker Swarm - Woodytoys Wiki</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="Woodytoys documentation">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction</a></li><li class="chapter-item expanded "><a href="../setting-up/index.html"><strong aria-hidden="true">1.</strong> Setting up</a></li><li class="chapter-item expanded "><a href="../deployment/index.html"><strong aria-hidden="true">2.</strong> Deployment</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../deployment/networking.html"><strong aria-hidden="true">2.1.</strong> Networking</a></li><li class="chapter-item expanded "><a href="../deployment/intra/index.html"><strong aria-hidden="true">2.2.</strong> The intranet</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../deployment/intra/www.html"><strong aria-hidden="true">2.2.1.</strong> Showroom website</a></li><li class="chapter-item expanded "><a href="../deployment/intra/b2b.html"><strong aria-hidden="true">2.2.2.</strong> B2B website</a></li><li class="chapter-item expanded "><a href="../deployment/intra/erp.html"><strong aria-hidden="true">2.2.3.</strong> Administration website</a></li><li class="chapter-item expanded "><a href="../deployment/intra/dns.html"><strong aria-hidden="true">2.2.4.</strong> DNS server</a></li><li class="chapter-item expanded "><a href="../deployment/intra/db.html"><strong aria-hidden="true">2.2.5.</strong> Database</a></li><li class="chapter-item expanded "><a href="../deployment/intra/mail.html"><strong aria-hidden="true">2.2.6.</strong> Mail server</a></li></ol></li><li class="chapter-item expanded "><a href="../deployment/portainer.html"><strong aria-hidden="true">2.3.</strong> Portainer</a></li><li class="chapter-item expanded "><a href="../deployment/swarm.html" class="active"><strong aria-hidden="true">2.4.</strong> Docker Swarm</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Woodytoys Wiki</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/austreelis//2tm1-admin-sys2" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/austreelis/2tm1-admin-sys2/edit/main/src/deployment/swarm.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="docker-swarm"><a class="header" href="#docker-swarm">Docker Swarm</a></h1>
<p>Although it wasn't extensively tested, deploying with Docker Swarm should be
straightforward.</p>
<h3 id="why-use-swarm-"><a class="header" href="#why-use-swarm-">Why use Swarm ?</a></h3>
<p>The benefits of deploying using Docker Swarm mainly are the following:</p>
<h4 id="using-the-portainer-agent"><a class="header" href="#using-the-portainer-agent">Using the Portainer Agent</a></h4>
<p>A Portainer Agent installed on the host allows managing several hosts from a
single Portainer server. Even without Swarm, it would be the easiest solution
to manage two separate hosts running Woodytoys' containers (instead of having
two different Portainer servers).</p>
<p>The &quot;default&quot; setup outlined in this documentation runs a Portainer server
on the host, alongside all other containers. It directly talks to the host's
Docker daemon. While it's possible to use the Portainer Agent with this setup
already, we did not set this up. However, it's considered bad practice not to
when using Swarm (and practically a lot harder to manage).</p>
<p>So while the Portainer Agent could come useful without Swarm, it's not really
worth the work to setup just yet, but could bring more value than just enabling
Swarm.</p>
<h4 id="better-scalability"><a class="header" href="#better-scalability">Better scalability</a></h4>
<p>Swarm allows to easily replicate services and run them accross several
hosts (nodes, in Swarm jargon). While this needs some more work than what's
currently setup, it should only require some adjustment to the routing and
DNS infrastructure.</p>
<h3 id="deploying-with-docker-swarm"><a class="header" href="#deploying-with-docker-swarm">Deploying with Docker Swarm</a></h3>
<p>To deploy Woodytoys' stack with Swarm, you should first choose a host, or node,
that will act as a &quot;manager&quot; for the swarm. All nodes may be manager, but you
may want some nodes to only be able to run services without managing others.</p>
<blockquote>
<p>For instance, with enough nodes, it's common to have some dedicated to
&quot;public-facing&quot; services so that comprimising one of them doesn't necessarily
gives managing rights on the Swarm.</p>
</blockquote>
<p>On the &quot;initial&quot; manager node, create a new swarm. You may want to look at the
options first:</p>
<pre><code class="language-bash">docker swarm init --help
# Then actually create one, adding options you see fit
docker swarm init --advertise-addr ens33 --listen-addr ens33
</code></pre>
<p>Then run the portainer agent:</p>
<pre><code class="language-bash">docker run -d \
  -p 9001:9001 \
  --restart always \
  --name portainer_agent \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v /var/lib/docker/volumes:/var/lib/docker/volumes \
  portainer/agent:latest
</code></pre>
<p>Before continuing to setup Portainer in the next section. You may run the
server on this host, or any other, as long as it can reach its port <code>9001</code>.</p>
<p>See also <a href="https://docs.portainer.io/admin/environments/add/docker/agent">Portainer's</a> and <a href="https://docs.docker.com/engine/swarm/">Docker's</a>
documentation.</p>
<h3 id="adding-a-node-to-the-swarm"><a class="header" href="#adding-a-node-to-the-swarm">Adding a node to the Swarm</a></h3>
<p>To add a node, you will need to generate a &quot;worker&quot; or &quot;manager&quot; token
(depending on which kind of node you want to add), from any existing manager
node:</p>
<pre><code class="language-bash">docker swarm join-token worker
# Or manager instead of worker
</code></pre>
<p>Copy or transfer the token somehow, then on the new node:</p>
<pre><code class="language-bash">docker swarm join --token &lt;the-token-from-previous-step&gt; &lt;manager-ip&gt;:&lt;port&gt;
</code></pre>
<p>Finally, run the portainer agent:</p>
<pre><code class="language-bash">docker run -d \
  -p 9001:9001 \
  --restart always \
  --name portainer_agent \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v /var/lib/docker/volumes:/var/lib/docker/volumes \
  portainer/agent:latest
</code></pre>
<p>You should be able to deploy services to this node from your Portainer server.</p>
<p>See also <a href="https://docs.portainer.io/admin/environments/add/docker/agent">Portainer's</a> and <a href="https://docs.docker.com/engine/swarm/">Docker's</a>
documentation.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../deployment/portainer.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../deployment/portainer.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
